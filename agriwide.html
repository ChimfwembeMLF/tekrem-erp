<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agricultural AI Chat - Test Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto max-w-4xl p-4">
        <!-- Header -->
        <div class="bg-green-600 text-white p-6 rounded-t-lg shadow-lg">
            <h1 class="text-2xl font-bold">üåæ AgriWide AI Assistant - Test Interface</h1>
            <p class="text-green-100 text-sm mt-1">Test your n8n agricultural AI agent</p>
        </div>

        <!-- Previous Conversations -->
        <div class="bg-white p-4 rounded-lg shadow-lg mt-4">
            <h2 class="text-lg font-semibold mb-3">Previous Conversations</h2>
            <div id="previousConversations" class="space-y-2"></div>
        </div>

        <!-- Configuration Panel -->
        <div class="bg-white p-4 shadow-lg border-b">
            <h2 class="text-lg font-semibold mb-3">Configuration</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">API Endpoint</label>
                    <input type="text" id="apiEndpoint" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                           placeholder="https://your-n8n-instance.com/webhook/chat/message"
                           value="http://localhost:5678/webhook/chat/message">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Session ID</label>
                    <input type="text" id="sessionId" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                           placeholder="550e8400-e29b-41d4-a716-446655440000">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">User Name</label>
                    <input type="text" id="userName" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                           placeholder="John Farmer"
                           value="John Farmer">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Farm Name</label>
                    <input type="text" id="farmName" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                           placeholder="Green Valley Farm"
                           value="Green Valley Farm">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Location</label>
                    <input type="text" id="location" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                           placeholder="Lusaka, Zambia"
                           value="Lusaka, Zambia">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Language</label>
                    <input type="text" id="language" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
                           placeholder="en"
                           value="en">
                </div>
            </div>
            <button onclick="generateSessionId()" 
                    class="mt-3 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm">
                Generate New Session ID
            </button>
            <button onclick="clearChat()" 
                    class="mt-3 ml-2 px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm">
                Clear Chat
            </button>
        </div>

        <!-- Chat Container -->
        <div class="bg-white shadow-lg" style="height: 500px;">
            <div id="chatMessages" class="h-full overflow-y-auto p-4 space-y-4">
                <div class="text-center text-gray-500 text-sm">
                    Start a conversation with the Agricultural AI Assistant
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="bg-white p-4 rounded-b-lg shadow-lg">
            <!-- Attachment Display -->
            <div id="attachmentDisplay" class="mb-3 hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-blue-600">üìé</span>
                            <span id="attachmentName" class="text-sm text-gray-700 font-medium"></span>
                            <span id="attachmentSize" class="text-xs text-gray-500"></span>
                        </div>
                        <button onclick="removeAttachment()" 
                                class="text-red-500 hover:text-red-700 text-sm font-medium">
                            Remove
                        </button>
                    </div>
                </div>
            </div>

            <div class="flex gap-2">
                <input type="text" id="messageInput" 
                       class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                       placeholder="Ask about crops, weather, soil, irrigation..."
                       onkeypress="if(event.key === 'Enter') sendMessage()">
                
                <label for="fileInput" class="px-4 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 cursor-pointer flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
                    </svg>
                    <span class="hidden md:inline">Attach</span>
                </label>
                <input type="file" id="fileInput" class="hidden" onchange="handleFileSelect(event)" 
                       accept=".pdf,.txt,.doc,.docx">
                
                <button onclick="sendMessage()" 
                        id="sendButton"
                        class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium disabled:bg-gray-400 disabled:cursor-not-allowed">
                    Send
                </button>
            </div>
            <div id="statusMessage" class="mt-2 text-sm text-gray-600"></div>
        </div>

        <!-- Request/Response Viewer -->
        <div class="bg-white mt-4 p-4 rounded-lg shadow-lg">
            <h2 class="text-lg font-semibold mb-3">Debug Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Last Request:</h3>
                    <pre id="requestDebug" class="bg-gray-100 p-3 rounded text-xs overflow-auto max-h-64">No request yet</pre>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Last Response:</h3>
                    <pre id="responseDebug" class="bg-gray-100 p-3 rounded text-xs overflow-auto max-h-64">No response yet</pre>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                <div>
                    <h3 class="text-sm font-medium text-blue-700 mb-2">Generate Title Request:</h3>
                    <pre id="titleRequestDebug" class="bg-blue-50 p-3 rounded text-xs overflow-auto max-h-64">No request yet</pre>
                </div>
                <div>
                    <h3 class="text-sm font-medium text-blue-700 mb-2">Generate Title Response:</h3>
                    <pre id="titleResponseDebug" class="bg-blue-50 p-3 rounded text-xs overflow-auto max-h-64">No response yet</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        let messages = [];
        let currentAttachment = null;
        let chatTitle = null;
        let sessionId = document.getElementById('sessionId') ? document.getElementById('sessionId').value : null;

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function generateSessionId() {
            const newSessionId = generateUUID();
            document.getElementById('sessionId').value = newSessionId;
            sessionId = newSessionId;
            clearChat();
            alert('New session ID generated: ' + newSessionId);
        }

        if (!document.getElementById('sessionId').value) generateSessionId();

        function clearChat() {
            messages = [];
            currentAttachment = null;
            chatTitle = null;
            document.getElementById('chatMessages').innerHTML = `<div class="text-center text-gray-500 text-sm">Start a conversation with the Agricultural AI Assistant</div>`;
            document.getElementById('requestDebug').textContent = 'No request yet';
            document.getElementById('responseDebug').textContent = 'No response yet';
            document.getElementById('attachmentDisplay').classList.add('hidden');
            displayChatTitle();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const allowedTypes = ['application/pdf', 'text/plain', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            if (!allowedTypes.includes(file.type)) { alert('Please select a PDF, TXT, DOC, or DOCX file'); event.target.value=''; return; }
            if (file.size > 10*1024*1024) { alert('File size must be <10MB'); event.target.value=''; return; }

            currentAttachment = { file: file, name: file.name, size: file.size, type: file.type };

            document.getElementById('attachmentName').textContent = file.name;
            document.getElementById('attachmentSize').textContent = formatFileSize(file.size);
            document.getElementById('attachmentDisplay').classList.remove('hidden');
            event.target.value = '';
        }

        function removeAttachment() { currentAttachment=null; document.getElementById('attachmentDisplay').classList.add('hidden'); }

        function formatFileSize(bytes) { if (bytes===0) return '0 Bytes'; const k=1024,sizes=['Bytes','KB','MB'],i=Math.floor(Math.log(bytes)/Math.log(k)); return Math.round(bytes/Math.pow(k,i)*100)/100+' '+sizes[i]; }

        function addMessageToUI(role, content, isError=false, hasAttachment=false) {
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages.children.length===1 && chatMessages.children[0].textContent.includes('Start a conversation')) chatMessages.innerHTML='';
            const messageDiv=document.createElement('div');
            messageDiv.className=`flex ${role==='user'?'justify-end':'justify-start'}`;
            const bubbleClass = isError ? 'bg-red-100 text-red-800 border border-red-300' : role==='user'?'bg-green-600 text-white':'bg-gray-200 text-gray-800';
            let attachmentBadge = '';
            if (hasAttachment && role==='user') attachmentBadge=`<div class="text-xs mt-1 opacity-75">üìé ${currentAttachment.name}</div>`;
            messageDiv.innerHTML=`<div class="${bubbleClass} rounded-lg px-4 py-3 max-w-2xl shadow"><div class="font-semibold text-sm mb-1">${role==='user'?'üë®‚Äçüåæ You':isError?'‚ö†Ô∏è Error':'ü§ñ AI Assistant'}</div><div class="whitespace-pre-wrap">${content}</div>${attachmentBadge}</div>`;
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop=chatMessages.scrollHeight;
        }

        function setStatus(message,isError=false){const statusEl=document.getElementById('statusMessage');statusEl.textContent=message;statusEl.className=`mt-2 text-sm ${isError?'text-red-600':'text-gray-600'}`;}

        async function sendMessage() {
            const messageInput=document.getElementById('messageInput');
            const message=messageInput.value.trim();
            if(!message){setStatus('Please enter a message',true);return;}

            const apiEndpoint=document.getElementById('apiEndpoint').value;
            sessionId=document.getElementById('sessionId').value;
            const userName=document.getElementById('userName').value;
            const farmName=document.getElementById('farmName').value;
            const location=document.getElementById('location').value;
            const language=document.getElementById('language').value;
            if(!apiEndpoint||!sessionId){setStatus('Please configure API endpoint and session ID',true);return;}

            const hasAttachment = currentAttachment!==null;
            messages.push({ role:'user', content:message });
            addMessageToUI('user', message, false, hasAttachment);
            messageInput.value='';
            const sendButton=document.getElementById('sendButton'); sendButton.disabled=true; setStatus('Sending message...');

            let attachments = [];
            if(currentAttachment){
                const reader=new FileReader();
                attachments = await new Promise((resolve,reject)=>{
                    reader.onload=()=>resolve([{ name: currentAttachment.name, type: currentAttachment.type, content: reader.result.split(',')[1] }]);
                    reader.onerror=reject;
                    reader.readAsDataURL(currentAttachment.file);
                });
            }

            // Send /chat/generate-title only for the first user message
            if (messages.length === 1) {
                const titleReqPayload = { message, session_id: sessionId };
                document.getElementById('titleRequestDebug').textContent = JSON.stringify(titleReqPayload, null, 2);
                try {
                    const titleResponse = await fetch(apiEndpoint.replace('/chat/message', '/chat/generate-title'), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(titleReqPayload)
                    });
                    let titleRespData;
                    if (titleResponse.ok) {
                        titleRespData = await titleResponse.json();
                        chatTitle = titleRespData.title;
                        displayChatTitle();
                        saveConversation(sessionId, chatTitle);
                    } else {
                        titleRespData = { error: true, status: titleResponse.status, message: await titleResponse.text() };
                        chatTitle = null;
                        displayChatTitle();
                        saveConversation(sessionId, chatTitle);
                    }
                    document.getElementById('titleResponseDebug').textContent = JSON.stringify(titleRespData, null, 2);
                } catch (err) {
                    chatTitle = null;
                    displayChatTitle();
                    saveConversation(sessionId, chatTitle);
                    document.getElementById('titleResponseDebug').textContent = `Error: ${err.message}`;
                }
            }

            const requestPayload={
                session_id: sessionId,
                metadata: { user_id:'test_user_'+Date.now(), user_name:userName, farm_name:farmName, location, language },
                messages: messages,
                attachments: attachments
            };

            document.getElementById('requestDebug').textContent=JSON.stringify(requestPayload,null,2);

            try {
                setStatus('Waiting for response...');
                const response = await fetch(apiEndpoint,{ method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(requestPayload) });
                const responseData=await response.json();
                document.getElementById('responseDebug').textContent=JSON.stringify(responseData,null,2);

                if(!response.ok) throw new Error(responseData.message||`HTTP ${response.status}: ${response.statusText}`);

                messages.push({ role:'assistant', content:responseData.message.content });
                addMessageToUI('assistant', responseData.message.content);

                const meta=responseData.metadata;
                const attachmentInfo=responseData.attachments_processed>0?`, ${responseData.attachments_processed} file(s)`:'';
                setStatus(`‚úì Response received (${meta.tokens_used} tokens, ${meta.processing_time_ms}ms${attachmentInfo})`);
                if(currentAttachment) removeAttachment();
            } catch(error){ console.error('Error:',error); addMessageToUI('error', `Failed to send message: ${error.message}`,true); setStatus(`Error: ${error.message}`,true); document.getElementById('responseDebug').textContent=`Error: ${error.message}\n\n${error.stack||''}`; }
            finally{ sendButton.disabled=false; messageInput.focus(); }
        }

        function sendQuickTest(testMessage){ document.getElementById('messageInput').value=testMessage; sendMessage(); }

        function displayChatTitle() {
            let header = document.querySelector('.bg-green-600.text-white.p-6');
            let titleEl = document.getElementById('chatTitleDisplay');
            if (!titleEl) {
                titleEl = document.createElement('div');
                titleEl.id = 'chatTitleDisplay';
                titleEl.className = 'mt-2 text-lg font-semibold text-yellow-200';
                header.appendChild(titleEl);
            }
            if (chatTitle) {
                titleEl.textContent = `üìù Chat Title: ${chatTitle}`;
            } else {
                titleEl.textContent = '';
            }
        }

        // Save conversation to localStorage
        function saveConversation(sessionId, title) {
            if (!sessionId) return;
            let conversations = JSON.parse(localStorage.getItem('agriwide_conversations') || '[]');
            // Remove any previous entry for this session
            conversations = conversations.filter(c => c.sessionId !== sessionId);
            conversations.unshift({ sessionId, title: title || 'Untitled', date: new Date().toISOString() });
            // Limit to last 10 conversations
            conversations = conversations.slice(0, 10);
            localStorage.setItem('agriwide_conversations', JSON.stringify(conversations));
            renderPreviousConversations();
        }

        // Render previous conversations in the UI
        function renderPreviousConversations() {
            const container = document.getElementById('previousConversations');
            if (!container) return;
            let conversations = JSON.parse(localStorage.getItem('agriwide_conversations') || '[]');
            if (conversations.length === 0) {
                container.innerHTML = '<div class="text-gray-500 text-sm">No previous conversations yet.</div>';
                return;
            }
            container.innerHTML = '';
            conversations.forEach(conv => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-gray-50 border border-gray-200 rounded px-3 py-2';
                div.innerHTML = `<span class='font-medium text-green-700'>${conv.title}</span><span class='text-xs text-gray-500'>${new Date(conv.date).toLocaleString()}</span>`;
                container.appendChild(div);
            });
        }

        // Render on load
        window.addEventListener('load', () => {
            document.getElementById('messageInput').focus();
            renderPreviousConversations();
        });
        window.addEventListener('load',()=>{ document.getElementById('messageInput').focus(); });
    </script>

    <!-- Quick Test Buttons -->
    <div class="container mx-auto max-w-4xl p-4 mt-4">
        <div class="bg-white p-4 rounded-lg shadow-lg">
            <h2 class="text-lg font-semibold mb-3">Quick Test Messages</h2>
            <div class="flex flex-wrap gap-2">
                <button onclick="sendQuickTest('Hello!')" 
                        class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm">
                    üëã Greeting
                </button>
                <button onclick="sendQuickTest('What crops should I plant in Lusaka during this season?')" 
                        class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 text-sm">
                    üå± Crop Advice
                </button>
                <button onclick="sendQuickTest('How do I improve my soil for groundnuts?')" 
                        class="px-4 py-2 bg-amber-500 text-white rounded-md hover:bg-amber-600 text-sm">
                    üåæ Soil Question
                </button>
                <button onclick="sendQuickTest('What is the current date and time?')" 
                        class="px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 text-sm">
                    üïê DateTime Test
                </button>
                <button onclick="sendQuickTest('Tell me about irrigation systems for small farms')" 
                        class="px-4 py-2 bg-cyan-500 text-white rounded-md hover:bg-cyan-600 text-sm">
                    üíß Irrigation
                </button>
            </div>
            
            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-blue-800">
                    <strong>üìé File Attachments:</strong> Click the "Attach" button to add PDF, TXT, DOC, or DOCX files (max 10MB). 
                    The file will now be sent as base64 to your n8n workflow.
                </p>
            </div>
        </div>
    </div>
    <a href="https://www.digitalocean.com/?refcode=229e9a16b30b&utm_campaign=Referral_Invite&utm_medium=Referral_Program&utm_source=badge"><img src="https://web-platforms.sfo2.cdn.digitaloceanspaces.com/WWW/Badge%201.svg" alt="DigitalOcean Referral Badge" /></a>
</body>
</html>
