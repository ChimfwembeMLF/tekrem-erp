name: Build and Deploy Laravel App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, bcmath, xml, ctype, fileinfo, json, tokenizer, mysql, pdo, openssl, zip

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Install NPM dependencies
        run: yarn install --frozen-lockfile || npm ci

      - name: Build frontend assets
        run: |
          if [ -f vite.config.ts ] || [ -f vite.config.js ]; then
            yarn run build || npm run build
          fi

      - name: Copy .env.example to .env (if needed)
        run: |
          if [ ! -f .env ]; then cp .env.example .env; fi

      - name: Generate application key
        run: php artisan key:generate

      - name: Cache Laravel config
        run: php artisan config:cache

      - name: Cache Laravel routes
        run: php artisan route:cache

      - name: Cache Laravel views
        run: php artisan view:cache

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: laravel-app
          path: |
            public/build
            public/assets
            resources/js
            resources/css
            vendor
            bootstrap/cache
            storage/app/public
            .env
            composer.lock
            yarn.lock
            package-lock.json
            node_modules/.cache
            artisan
            database/migrations
            database/seeders
            database/factories
            app
            config
            routes
            resources/views
            resources/lang
            public/index.php
            public/robots.txt
            public/storage
            phpunit.xml
            tailwind.config.js
            postcss.config.js
            vite.config.*
            tsconfig.json
            jsconfig.json
            Dockerfile
            docker-compose.yml
            nginx.conf
            README.md

  # Add a deploy job here if you want to auto-deploy to CyberPanel or another server
  # Example: scp/rsync to server, or use FTP/SFTP, or trigger a webhook
